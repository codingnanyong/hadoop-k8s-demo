apiVersion: apps/v1
kind: Deployment
metadata:
  name: historyserver
  namespace: hadoop
spec:
  replicas: 1
  selector:
    matchLabels:
      app: historyserver
  template:
    metadata:
      labels:
        app: historyserver
    spec:
      initContainers:
        - name: wait-hdfs
          image: busybox:1.36
          command: ["sh", "-c", "until nc -z namenode-svc 8020; do echo waiting for HDFS; sleep 3; done"]
        - name: merge-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp -r /config/* /out/ && cp /override/mapred-site.xml /out/mapred-site.xml
          volumeMounts:
            - name: hadoop-config
              mountPath: /config
            - name: historyserver-mapred
              mountPath: /override
            - name: merged-config
              mountPath: /out
      containers:
        - name: historyserver
          image: apache/hadoop:3.4.0
          command: ["mapred", "historyserver"]
          ports:
            - containerPort: 10020
            - containerPort: 19888
          volumeMounts:
            - name: merged-config
              mountPath: /opt/hadoop/etc/hadoop
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
      volumes:
        - name: hadoop-config
          configMap:
            name: hadoop-config
        - name: historyserver-mapred
          configMap:
            name: historyserver-mapred
        - name: merged-config
          emptyDir: {}
